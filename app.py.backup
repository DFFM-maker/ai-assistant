#!/usr/bin/env python3
from flask import Flask, render_template, request, jsonify
import requests
import os
import sys
sys.path.append('/opt/ai-assistant')
from config import get_config

app = Flask(__name__)
config = get_config()

@app.route('/')
def index():
    return jsonify({
        "status": "AI Assistant for DFFM - Running",
        "gitlab_url": config.GITLAB_URL,
        "default_model": config.DEFAULT_MODEL,
        "cpu_threads": config.CPU_THREADS
    })

@app.route('/health')
def health():
    return jsonify({"status": "OK", "cpu_threads": config.CPU_THREADS})

@app.route('/api/models')
def list_models():
    try:
        r = requests.get(f'{config.OLLAMA_URL}/api/tags', timeout=5)
        return jsonify(r.json())
    except:
        return jsonify({"error": "Ollama not available"}), 500

@app.route('/api/generate', methods=['POST'])
def generate_ai():
    data = request.json
    prompt = data.get('prompt', '')
    model = data.get('model', config.DEFAULT_MODEL)
    
    payload = {
        "model": model,
        "prompt": prompt,
        "stream": False
    }
    
    try:
        r = requests.post(f'{config.OLLAMA_URL}/api/generate', json=payload, timeout=300)
        return jsonify(r.json())
    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    app.run(host=config.HOST, port=config.PORT, debug=config.DEBUG)
